import secrets
from datetime import datetime, timedelta
from config.database import prepare  # using your helper

class SessionService:
    @staticmethod
    def find_by_token(token):
        stmt = prepare("""
            SELECT s.*, u.name, u.email, u.role 
            FROM sessions s
            JOIN users u ON s.user_id = u.id
            WHERE s.token = :token AND s.is_active = 1 AND s.expires_at > :now
        """)
        now = datetime.now().isoformat()
        row = stmt({"token": token, "now": now}).fetchone()
        return dict(row) if row else None  # return dict for easy access

    @staticmethod
    def create(user_id, ip_address):
        token = secrets.token_hex(32)  # generates a secure 64-char token
        expires_at = (datetime.now() + timedelta(days=7)).isoformat()
        stmt = prepare("""
            INSERT INTO sessions (user_id, token, ip_address, expires_at, is_active, last_activity)
            VALUES (:user_id, :token, :ip_address, :expires_at, 1, :now)
        """)
        now = datetime.now().isoformat()
        # ✅ no `.execute()` here
        stmt({
            "user_id": user_id,
            "token": token,
            "ip_address": ip_address,
            "expires_at": expires_at,
            "now": now
        })
        return token

    @staticmethod
    def update_activity(token):
        stmt = prepare("""
            UPDATE sessions 
            SET last_activity = :now 
            WHERE token = :token AND is_active = 1
        """)
        now = datetime.now().isoformat()
        # ✅ no `.execute()` here
        stmt({"token": token, "now": now})


